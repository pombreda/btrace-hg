<?xml version="1.0" encoding="UTF-8"?>
<project name="BTrace" default="all" basedir=".">

  <!-- Property Definitions -->
    <target name="prepare" depends="load.properties">
        <mkdir dir="${classes.dir}"/>
        <mkdir dir="${javadoc.dir}"/>
        <available classname="org.opensolaris.os.dtrace.Consumer"
        classpath="/usr/share/lib/java/dtrace.jar"
        property="libdtrace.jni.available"/>
        <path id="javac.classpath">
            <pathelement path="${lib.dir}/asm-3.0.jar" />
            <pathelement path="${java.home}/../lib/tools.jar" />
            <pathelement path="/usr/share/lib/java/dtrace.jar" />
        </path>
    </target>
    <target name="clean" depends="load.properties">
        <delete dir="${build.dir}"/>
        <delete dir="${javadoc.dir}"/>
        <delete dir="${dist.dir}"/>
    </target>
    <target name="compile" depends="prepare" description="Compiles the sources">
        <javac srcdir="${share.src.dir}"
           destdir="${classes.dir}"
           debug="on" deprecation="on">
            <classpath refid="javac.classpath" />
        </javac>
        <copy todir="${classes.dir}/com/sun/btrace/resources">
            <fileset dir="${share.src.dir}/com/sun/btrace/resources/"/>
        </copy>
        <copy todir="${classes.dir}/com/sun/btrace/runtime">
            <fileset file="${share.src.dir}/com/sun/btrace/runtime/jaxb.index"/>
        </copy>
        <copy todir="${classes.dir}/com/sun/btrace/annotations">
            <fileset file="${share.src.dir}/com/sun/btrace/annotations/jaxb.index"/>
        </copy>
        <javadoc destdir="${javadoc.dir}">
            <fileset file="${share.src.dir}/com/sun/btrace/annotations/*.java"/>
            <fileset file="${share.src.dir}/com/sun/btrace/AnyType.java"/>
            <fileset file="${share.src.dir}/com/sun/btrace/BTraceUtils.java"/>
        </javadoc>
    </target>
    <target name="dtrace-compile" if="libdtrace.jni.available" depends="prepare">
        <javac srcdir="${solaris.src.dir}"
           destdir="${classes.dir}"
           debug="on" deprecation="on">
            <classpath refid="javac.classpath"/>
        </javac>
    </target>
    <target name="build" depends="compile, dtrace-compile" description="Creates deployment bundles">
        <copy todir="${build.dir}">
            <fileset file="${lib.dir}/asm-3.0.jar"/>
        </copy>
        <jar jarfile="${agent.jar}"         
         basedir="${classes.dir}"
         manifest="${share.src.dir}/META-INF/agent-manifest.mf"
         excludes="**/dtrace/* **/btrace/*.class **/annotations/* **/compiler/* **/client/* **/comm/*"/>
        <jar jarfile="${boot.jar}"         
         basedir="${classes.dir}"
         excludes="**/dtrace/* **/agent/* **/compiler/* **/client/* **/resources/* **/runtime/* **/util/*"/>
        <jar jarfile="${client.jar}"
         basedir="${classes.dir}"
         manifest="${share.src.dir}/META-INF/client-manifest.mf"
         excludes="**/runtime/* **/agent/*"/>
    </target>
    <target name="load.properties">
        <echo message="Loading build properties file"/>
        <property file="build.properties"/>
    </target>
    <target name="dist" depends="build">
        <delete dir="vi${dist.dir}"/>
        <mkdir dir="${dist.dir}"/>
        <mkdir dir="${dist.dir}/build"/>
        <mkdir dir="${dist.dir}/bin"/>
        <mkdir dir="${dist.dir}/samples"/>
        <mkdir dir="${dist.dir}/docs"/>
        <copy todir="${dist.dir}/build">
            <fileset file="${build.dir}/*.jar"/>
        </copy>
        <copy todir="${dist.dir}/bin">
            <fileset file="${bin.dir}/*"/>
        </copy>
        <copy todir="${dist.dir}/samples">
            <fileset file="${samples.dir}/*"/>
        </copy>
        <copy todir="${dist.dir}/docs">
            <fileset file="${docs.dir}/usersguide.html"/>
        </copy>
        <copy todir="${dist.dir}/docs/javadoc">
            <fileset dir="${docs.dir}/javadoc"/>
        </copy>
        <copy todir="${dist.dir}">
            <fileset file="${basedir}/../*.txt"/>
            <fileset file="${basedir}/../COPYRIGHT"/>
        </copy>
        <tar basedir="${dist.dir}" destfile="${dist.dir}/btrace-bin.tar.gz" 
             compression="gzip" excludes="*.zip,*.gz"/>
        <zip basedir="${dist.dir}" destfile="${dist.dir}/btrace-bin.zip"
             excludes="*.zip,*.gz"/>
    </target>
    <target name="all" depends="build" description="Builds sources and deployment jars"/>
</project>

